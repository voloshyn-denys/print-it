import React, { useState, useEffect, useRef } from 'react';
import {fabric} from "fabric";

const SVG_CLIP_URL = 
    `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 512.001 512.001" style="enable-background:new 0 0 512.001 512.001;" xml:space="preserve">
        <g>
            <path d="M81.067,34.133c-14.114,0-25.6-11.486-25.6-25.6C55.467,3.814,51.653,0,46.934,0S38.4,3.814,38.4,8.533     c0,14.114-11.486,25.6-25.6,25.6c-4.719,0-8.533,3.814-8.533,8.533S8.082,51.2,12.8,51.2c14.114,0,25.6,11.486,25.6,25.6     c0,4.719,3.814,8.533,8.533,8.533s8.533-3.814,8.533-8.533c0-14.114,11.486-25.6,25.6-25.6c4.719,0,8.533-3.814,8.533-8.533     S85.786,34.133,81.067,34.133z M46.934,51.226c-2.432-3.243-5.316-6.127-8.559-8.559c3.243-2.432,6.127-5.316,8.559-8.559     c2.432,3.243,5.316,6.127,8.559,8.559C52.25,45.099,49.366,47.983,46.934,51.226z"/>
            <path d="M482.134,136.534H473.6v-8.533c0-4.719-3.814-8.533-8.533-8.533c-4.719,0-8.533,3.814-8.533,8.533v8.533H448     c-4.719,0-8.533,3.814-8.533,8.533s3.814,8.533,8.533,8.533h8.533v8.533c0,4.719,3.814,8.533,8.533,8.533     c4.719,0,8.533-3.814,8.533-8.533v-8.533h8.533c4.719,0,8.533-3.814,8.533-8.533S486.853,136.534,482.134,136.534z"/>
            <circle cx="64" cy="375.468" r="8.533"/>
            <circle cx="21.334" cy="221.868" r="8.533"/>
            <circle cx="439.467" cy="307.201" r="8.533"/>
            <circle cx="499.2" cy="486.401" r="8.533"/>
            <path d="M277.334,469.334c0-9.412-7.654-17.067-17.067-17.067c-9.412,0-17.067,7.654-17.067,17.067     c0,9.412,7.654,17.067,17.067,17.067C269.679,486.401,277.334,478.746,277.334,469.334z"/>
            <path d="M371.533,0.001H149.001c-18.637,0-33.801,15.164-33.801,33.801v17.399h290.133V33.801     C405.334,15.165,390.17,0.001,371.533,0.001z M226.134,34.134H217.6c-4.71,0-8.533-3.823-8.533-8.533     c0-4.71,3.823-8.533,8.533-8.533h8.533c4.71,0,8.533,3.823,8.533,8.533C234.667,30.311,230.844,34.134,226.134,34.134z      M294.4,34.134h-42.667c-4.71,0-8.533-3.823-8.533-8.533c0-4.71,3.823-8.533,8.533-8.533H294.4c4.71,0,8.533,3.823,8.533,8.533     C302.934,30.311,299.111,34.134,294.4,34.134z"/>
            <path d="M294.4,469.334c0,18.825-15.309,34.133-34.133,34.133s-34.133-15.309-34.133-34.133c0-10.24,4.625-19.337,11.793-25.6     H115.2V478.2c0,18.637,15.164,33.8,33.801,33.8h222.532c18.637,0,33.8-15.164,33.8-33.8v-34.466H282.607     C289.775,449.998,294.4,459.094,294.4,469.334z"/>
            <rect x="200.534" y="264.534" width="17.067" height="51.2"/>
            <rect x="302.934" y="264.534" width="17.067" height="51.2"/>
            <path d="M183.467,314.276v-48.282c-9.933,3.524-17.067,13.013-17.067,24.141C166.4,301.263,173.534,310.752,183.467,314.276z"/>
            <path d="M115.2,76.799c-4.71,0-8.533,3.823-8.533,8.533v8.533c0,4.71,3.823,8.533,8.533,8.533v8.533     c-4.71,0-8.533,3.823-8.533,8.533v8.533c0,4.71,3.823,8.533,8.533,8.533v8.533c-4.71,0-8.533,3.823-8.533,8.533v8.533     c0,4.71,3.823,8.533,8.533,8.533v256h290.133v-358.4H115.2V76.799z M174.934,251.084v-37.751     c0-47.053,38.281-85.333,85.333-85.333S345.6,166.28,345.6,213.333v37.751c15.044,6.605,25.6,21.598,25.6,39.049     c0,23.526-19.14,42.667-42.667,42.667H294.4c-4.719,0-8.533-3.814-8.533-8.533v-68.267c0-4.719,3.814-8.533,8.533-8.533h34.133     v-34.133c0-37.641-30.626-68.267-68.267-68.267S192,175.692,192,213.333v34.133h34.133c4.719,0,8.533,3.814,8.533,8.533v68.267     c0,4.719-3.814,8.533-8.533,8.533H192c-23.526,0-42.667-19.14-42.667-42.667C149.334,272.682,159.889,257.689,174.934,251.084z"/>
            <path d="M354.134,290.134c0-11.128-7.134-20.617-17.067-24.141v48.282C347,310.751,354.134,301.262,354.134,290.134z"/>
        </g>
    </svg>`;

const CanvasArea = (props) =>  {
    const [canvas, setCanvas] = useState(null);
    const canvas_ref = useRef(null);

    useEffect(() => {
        const canvas = new fabric.Canvas(canvas_ref.current);
        let svgPath = null;
        
        new fabric.loadSVGFromString(SVG_CLIP_URL, (objects, options) => { 
                svgPath = fabric.util.groupSVGElements(objects, options);
                let left = ((window.innerWidth - 300) / 2) - (svgPath.width / 2);
                let top = ((window.innerHeight - 46) / 2) - (svgPath.height / 2);
                svgPath.set({ selectable: false, left, top })
            }
        );

        canvas.controlsAboveOverlay = true;
        canvas.clipPath = svgPath;
        canvas.add(svgPath);

        setCanvas(canvas);
    }, [])

    const { width = 600, height = 400 } = props;

    const children = React.Children.map(props.children, child => {
        return React.cloneElement(child, { canvas });
    })

    return(
        <>
        <canvas 
            ref={canvas_ref} 
            width={width} 
            height={height} 
        />
        { canvas && children}
        </>
    )

}

export default CanvasArea;